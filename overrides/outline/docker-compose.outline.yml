services:
  # ------------------------------------------------------------
  # outline: shadowsocks client (sslocal-rust)
  # Provides SOCKS5 proxy inside Docker network on 0.0.0.0:1080
  # ------------------------------------------------------------
  outline:
    image: ghcr.io/shadowsocks/sslocal-rust:latest
    container_name: outline
    restart: unless-stopped

    volumes:
      - ./overrides/outline/sslocal.json:/etc/shadowsocks-rust/config.json:ro

    # IMPORTANT:
    # sslocal-rust uses -c (config file). There is NO -p option.
    # Docs/examples: Shadowsocks config includes local_port=1080 etc.
    # https://shadowsocks.org/doc/configs.html
    command: 
      - "sslocal"
      - "-c"
      - "/etc/shadowsocks-rust/config.json"

    expose:
      - "1080"

    # Healthcheck: verify that port 1080 is LISTEN (0A) in /proc/net/tcp
    # /proc/net/tcp state 0A = LISTEN
    # local port 1080 = 0x0438
    # Ref: /proc/net/tcp format description
    # https://jrehkemper.de/content/linux/procfs/proc-net/proc_net_tcp/
    healthcheck:
      test:
        - CMD-SHELL
        - |
          awk 'NR>1 {print $2, $4}' /proc/net/tcp \
            | grep -qE '(^| )00000000:0438 0A$'
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

  # ------------------------------------------------------------
  # privoxy: converts HTTP proxy -> SOCKS5 (outline:1080)
  # n8n and workers will use http://privoxy:8118 as http_proxy/https_proxy
  # ------------------------------------------------------------
  privoxy:
    image: vimagick/privoxy:latest
    container_name: privoxy
    restart: unless-stopped
    volumes:
      - ./overrides/outline/privoxy/config:/etc/privoxy/config:ro
    depends_on:
      outline:
        condition: service_healthy

    ports:
      # optional (for debugging from host). Usually you don't need to expose it.
      # - "8118:8118"
      - "127.0.0.1:8118:8118"

    environment:
      # This image reads env and generates forwarding config.
      # If your image behaves differently, weâ€™ll switch to a mounted config.
      FORWARD_SOCKS5: / outline:1080 .

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8118/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

  # ------------------------------------------------------------
  # Force n8n through proxy:
  # We set HTTP(S)_PROXY to privoxy.
  # NO_PROXY must include all internal docker service names.
  #
  # IMPORTANT:
  # This does NOT "NAT all traffic through VPN at kernel level".
  # It only forces apps that respect HTTP proxy env vars.
  # n8n does for HTTP(S) requests, node-fetch, axios, etc.
  # ------------------------------------------------------------
  n8n:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118

      # keep internal traffic direct
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  # ------------------------------------------------------------
  # n8n-worker-* come from docker-compose.n8n-workers.yml.
  # We add proxy env vars to ALL of them using extends-like merge.
  #
  # Docker Compose doesn't support wildcard names, so we patch them explicitly
  # (your generator currently makes n8n-worker-1..n).
  # ------------------------------------------------------------

  n8n-worker-1:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-1,n8n-runner-1,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-1,n8n-runner-1,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-worker-2:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-2,n8n-runner-2,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-2,n8n-runner-2,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-worker-3:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-3,n8n-runner-3,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-3,n8n-runner-3,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-worker-4:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-4,n8n-runner-4,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-4,n8n-runner-4,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-worker-5:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-5,n8n-runner-5,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-5,n8n-runner-5,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-runner-1:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-1,n8n-runner-1,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-1,n8n-runner-1,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-runner-2:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-2,n8n-runner-2,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-2,n8n-runner-2,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-runner-3:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-3,n8n-runner-3,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-3,n8n-runner-3,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-runner-4:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-4,n8n-runner-4,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-4,n8n-runner-4,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost

  n8n-runner-5:
    environment:
      http_proxy: http://privoxy:8118
      https_proxy: http://privoxy:8118
      HTTP_PROXY: http://privoxy:8118
      HTTPS_PROXY: http://privoxy:8118
      NO_PROXY: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-5,n8n-runner-5,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
      no_proxy: >-
        localhost,127.0.0.1,
        postgres,redis,caddy,outline,privoxy,
        n8n,n8n-import,n8n-worker-5,n8n-runner-5,
        qdrant,weaviate,neo4j,ollama,
        searxng,crawl4ai,gotenberg,langfuse-web,langfuse-worker,flowise,
        docling,postiz,ragflow,ragapp,open-webui,comfyui,waha,libretranslate,paddleocr,gost
